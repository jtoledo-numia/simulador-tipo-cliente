function norm(v){if(v==null)return"";let s=String(v).trim();if(/^[0-9]+$/.test(s)&&s.length===1)s="0"+s;return s;}
function matches(value,allowed){if(!allowed||allowed.length===0)return true;const v=norm(value);return allowed.includes(v);}
function classifyOne(input,rules){for(const r of rules){if(matches(input.banca,r.banca)&&matches(input.identificacion,r.identificacion)&&matches(input.categoria,r.categoria)&&matches(input.segmento,r.segmento)){return r.name;}}return "Sin coincidencias";}
function chipHTML(list){return(!list||list.length===0)?'<span class="muted">â€”</span>':`<div class="chips">${list.map(v=>`<span class="chip">${v}</span>`).join("")}</div>`;}
let RULES=[];
async function loadRules(){const res=await fetch('rules.json',{cache:'no-store'});const data=await res.json();RULES=(data.rules||[]).slice().sort((a,b)=>(a.order??999)-(b.order??999));document.getElementById('rulesCount').textContent=`(${RULES.length} reglas)`;const tbody=document.getElementById('rulesBody');tbody.innerHTML="";RULES.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.order??""}</td><td>${r.name??""}</td><td>${chipHTML(r.banca)}</td><td>${chipHTML(r.identificacion)}</td><td>${chipHTML(r.categoria)}</td><td>${chipHTML(r.segmento)}</td>`;tbody.appendChild(tr);});}
document.addEventListener('DOMContentLoaded',()=>{loadRules().catch(console.error);document.getElementById('simForm').addEventListener('submit',e=>{e.preventDefault();const input={banca:document.getElementById('banca').value,identificacion:document.getElementById('identificacion').value,categoria:document.getElementById('categoria').value,segmento:document.getElementById('segmento').value};const tipo=classifyOne(input,RULES);const out=document.getElementById('result');out.hidden=false;out.className="result "+(tipo==="Sin coincidencias"?"err":"ok");out.textContent=tipo;out.scrollIntoView({behavior:'smooth',block:'center'});});});